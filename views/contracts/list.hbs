<div class="row mb-4">
    <div class="col-md-6">
        <h2><i class="fas fa-file-contract"></i> Danh S√°ch H·ª£p ƒê·ªìng</h2>
    </div>
</div>

<!-- Contracts Table -->
{{#if contracts}}
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th><i class="fas fa-file-alt"></i> S·ªë Hƒê</th>
                        <th><i class="fas fa-user"></i> Kh√°ch h√†ng</th>
                        <th><i class="fas fa-car"></i> Xe</th>
                        <th><i class="fas fa-calendar"></i> Th·ªùi gian</th>
                        <th><i class="fas fa-money-bill"></i> T·ªïng ti·ªÅn</th>
                        <th><i class="fas fa-info-circle"></i> Tr·∫°ng th√°i</th>
                        <th class="text-center"><i class="fas fa-cog"></i> Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each contracts}}
                    <tr>
                        <td>{{inc @index}}</td>
                        <td>
                            <strong>{{this.contractNumber}}</strong>
                        </td>
                        <td>
                            {{#if this.booking.user}}
                                {{#if this.booking.user.fullName}}
                                    {{this.booking.user.fullName}}
                                {{else}}
                                    User ID: {{this.booking.user}}
                                {{/if}}
                            {{else}}
                                N/A
                            {{/if}}
                        </td>
                        <td>
                            {{#if this.car}}
                                {{#if this.car.brand}}
                                    {{this.car.brand}} {{this.car.model}}
                                    <br>
                                    <small class="text-muted">{{this.car.licensePlate}}</small>
                                {{else}}
                                    Car ID: {{this.car}}
                                {{/if}}
                            {{else}}
                                N/A
                            {{/if}}
                        </td>
                        <td>
                            <small>
                                {{formatDate this.startDate}}
                                <br>
                                <i class="fas fa-arrow-down"></i>
                                <br>
                                {{formatDate this.endDate}}
                            </small>
                        </td>
                        <td>
                            <strong class="text-primary">
                                {{formatCurrency this.totalAmount}}
                            </strong>
                        </td>
                        <td>
                            <span class="badge bg-{{statusBadge this.status}}">
                                {{this.status}}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <a href="/contracts/{{this._id}}" class="btn btn-outline-info" title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                Hi·ªÉn th·ªã <strong>{{contracts.length}}</strong> h·ª£p ƒë·ªìng
            </div>
        </div>
    </div>
</div>
{{else}}
<div class="alert alert-info text-center">
    <i class="fas fa-info-circle"></i> Ch∆∞a c√≥ h·ª£p ƒë·ªìng n√†o
</div>
{{/if}}

<!-- Statistics Cards -->
<div class="row mt-4">
    <div class="col-md-4 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h6>T·ªïng H·ª£p ƒê·ªìng</h6>
                <h3>{{contracts.length}}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h6>ƒêang Ho·∫°t ƒê·ªông</h6>
                <h3 id="activeCount">-</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h6>T·ªïng Doanh Thu</h6>
                <h3 id="totalRevenue">-</h3>
            </div>
        </div>
    </div>
</div>

<script>
function printContract(id) {
    window.open(`/contracts/${id}?print=true`, '_blank');
}

function downloadContract(id) {
    window.location.href = `/contracts/${id}/download`;
}

// Calculate statistics
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ Contracts List Page Loaded');
    
    try {
        const contracts = {{{json contracts}}};
        console.log(`üìä Found ${contracts.length} contracts`);
        
        const active = contracts.filter(c => c.status === 'ACTIVE').length;
        const total = contracts.reduce((sum, c) => sum + (c.totalAmount || 0), 0);
        
        console.log(`‚úÖ Stats - Active: ${active}, Total: ${total}`);
        
        document.getElementById('activeCount').textContent = active;
        document.getElementById('totalRevenue').textContent = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(total);
    } catch (error) {
        console.error('‚ùå Error calculating stats:', error);
    }
});
</script>