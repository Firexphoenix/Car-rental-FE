<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-calendar-check"></i> Chi Tiết Đặt Xe</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/bookings">Đặt xe</a></li>
                <li class="breadcrumb-item active">Chi tiết</li>
            </ol>
        </nav>
    </div>
</div>

{{#if booking}}
<div class="row">
    <!-- Booking Status Card -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-{{statusBadge booking.status}} text-white">
                <h5 class="mb-0">Trạng Thái</h5>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-calendar-check fa-5x text-{{statusBadge booking.status}} mb-3"></i>
                <h3>{{booking.status}}</h3>
                <p class="text-muted">Booking ID: {{booking._id}}</p>
            </div>
        </div>
    </div>

    <!-- Price Card -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Chi Tiết Giá</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <p class="mb-1 text-muted">Ngày bắt đầu</p>
                        <h5>{{formatDate booking.startDate}}</h5>
                    </div>
                    <div class="col-6">
                        <p class="mb-1 text-muted">Ngày kết thúc</p>
                        <h5>{{formatDate booking.endDate}}</h5>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Số ngày thuê:</span>
                    <strong id="rentalDays">-</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Giá mỗi ngày:</span>
                    <strong id="pricePerDay">-</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Tổng Tiền:</h5>
                    <h3 class="text-primary mb-0">{{formatCurrency booking.totalPrice}}</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customer Information -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-user"></i> Thông Tin Khách Hàng</h5>
            </div>
            <div class="card-body">
                {{#if booking.user}}
                <table class="table table-borderless">
                    <tr>
                        <td width="40%"><strong>Họ tên:</strong></td>
                        <td>
                            {{#if booking.user.fullName}}
                                {{booking.user.fullName}}
                            {{else}}
                                N/A
                            {{/if}}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Email:</strong></td>
                        <td>
                            {{#if booking.user.email}}
                                <a href="mailto:{{booking.user.email}}">{{booking.user.email}}</a>
                            {{else}}
                                N/A
                            {{/if}}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Điện thoại:</strong></td>
                        <td>
                            {{#if booking.user.phone}}
                                <a href="tel:{{booking.user.phone}}">{{booking.user.phone}}</a>
                            {{else}}
                                N/A
                            {{/if}}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Vai trò:</strong></td>
                        <td>
                            {{#if booking.user.role}}
                                <span class="badge bg-primary">{{booking.user.role}}</span>
                            {{else}}
                                N/A
                            {{/if}}
                        </td>
                    </tr>
                </table>
                <a href="/users/{{booking.user._id}}" class="btn btn-outline-info btn-sm">
                    <i class="fas fa-eye"></i> Xem Chi Tiết
                </a>
                {{else}}
                <p class="text-muted">Chưa có thông tin khách hàng</p>
                {{/if}}
            </div>
        </div>
    </div>

    <!-- Car Information -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-car"></i> Thông Tin Xe</h5>
            </div>
            <div class="card-body">
                {{#if booking.car}}
                {{#if booking.car.images.[0]}}
                <img src="{{booking.car.images.[0]}}" class="img-fluid rounded mb-3" alt="Car image" style="max-height: 150px; object-fit: cover; width: 100%;">
                {{/if}}
                <table class="table table-borderless">
                    <tr>
                        <td width="40%"><strong>Xe:</strong></td>
                        <td>
                            {{#if booking.car.brand}}
                                {{booking.car.brand}} {{booking.car.model}}
                            {{else}}
                                N/A
                            {{/if}}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Biển số:</strong></td>
                        <td>
                            {{#if booking.car.licensePlate}}
                                <strong class="text-primary">{{booking.car.licensePlate}}</strong>
                            {{else}}
                                N/A
                            {{/if}}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Màu sắc:</strong></td>
                        <td>{{booking.car.color}}</td>
                    </tr>
                    <tr>
                        <td><strong>Số chỗ:</strong></td>
                        <td>{{booking.car.seats}} chỗ</td>
                    </tr>
                </table>
                <a href="/cars/{{booking.car._id}}" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-eye"></i> Xem Chi Tiết
                </a>
                {{else}}
                <p class="text-muted">Chưa có thông tin xe</p>
                {{/if}}
            </div>
        </div>
    </div>
</div>

<!-- Notes -->
{{#if booking.notes}}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Ghi Chú</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{booking.notes}}</p>
            </div>
        </div>
    </div>
</div>
{{/if}}

<!-- Timeline -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Lịch Sử</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><i class="fas fa-calendar-plus text-primary"></i> <strong>Ngày tạo:</strong> {{formatDateTime booking.createdAt}}</p>
                    </div>
                    <div class="col-md-6">
                        <p><i class="fas fa-calendar-check text-success"></i> <strong>Cập nhật lần cuối:</strong> {{formatDateTime booking.updatedAt}}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-cog"></i> Thao Tác</h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    <a href="/bookings" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Quay Lại
                    </a>
                    
                    {{#if (eq booking.status 'PENDING')}}
                    <button class="btn btn-success" onclick="confirmBooking()">
                        <i class="fas fa-check"></i> Xác Nhận
                    </button>
                    <button class="btn btn-danger" onclick="cancelBooking()">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    {{/if}}
                    
                    {{#if (eq booking.status 'CONFIRMED')}}
                    <button class="btn btn-info" onclick="completeBooking()">
                        <i class="fas fa-flag-checkered"></i> Hoàn Thành
                    </button>
                    <a href="/contracts?bookingId={{booking._id}}" class="btn btn-warning">
                        <i class="fas fa-file-contract"></i> Xem Hợp Đồng
                    </a>
                    {{/if}}
                    
                    <button class="btn btn-outline-primary" onclick="printBooking()">
                        <i class="fas fa-print"></i> In
                    </button>
                    <button class="btn btn-outline-info" onclick="sendEmail()">
                        <i class="fas fa-envelope"></i> Gửi Email
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calculate rental days
const startDate = new Date('{{booking.startDate}}');
const endDate = new Date('{{booking.endDate}}');
const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

const rentalDaysEl = document.getElementById('rentalDays');
const pricePerDayEl = document.getElementById('pricePerDay');

if (rentalDaysEl) rentalDaysEl.textContent = days + ' ngày';

// Calculate price per day
const totalPrice = {{booking.totalPrice}} || 0;
const pricePerDay = days > 0 ? totalPrice / days : 0;

if (pricePerDayEl) {
    pricePerDayEl.textContent = new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
    }).format(pricePerDay);
}

async function confirmBooking() {
    if (confirm('Xác nhận đặt xe này?')) {
        try {
            const response = await fetch('http://localhost:3000/api/bookings/{{booking._id}}', {
                method: 'PUT', // ✅ ĐỔI TỪ PATCH → PUT
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'CONFIRMED' })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert('Đã xác nhận đặt xe thành công!');
                location.reload();
            } else {
                alert('Lỗi: ' + (result.message || 'Không thể xác nhận'));
                console.error('Error:', result);
            }
        } catch (error) {
            console.error('Fetch error:', error);
            alert('Lỗi kết nối: ' + error.message);
        }
    }
}

async function cancelBooking() {
    if (confirm('Hủy đặt xe này?')) {
        try {
            const response = await fetch('http://localhost:3000/api/bookings/{{booking._id}}', {
                method: 'PUT', // ✅ ĐỔI TỪ PATCH → PUT
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'CANCELLED' })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert('Đã hủy đặt xe thành công!');
                location.reload();
            } else {
                alert('Lỗi: ' + (result.message || 'Không thể hủy'));
                console.error('Error:', result);
            }
        } catch (error) {
            console.error('Fetch error:', error);
            alert('Lỗi kết nối: ' + error.message);
        }
    }
}

async function completeBooking() {
    if (confirm('Đánh dấu đặt xe này là hoàn thành?')) {
        try {
            const response = await fetch('http://localhost:3000/api/bookings/{{booking._id}}', {
                method: 'PUT', // ✅ ĐỔI TỪ PATCH → PUT
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'COMPLETED' })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert('Đã hoàn thành đặt xe!');
                location.reload();
            } else {
                alert('Lỗi: ' + (result.message || 'Không thể cập nhật'));
                console.error('Error:', result);
            }
        } catch (error) {
            console.error('Fetch error:', error);
            alert('Lỗi kết nối: ' + error.message);
        }
    }
}

function printBooking() {
    window.print();
}

function sendEmail() {
    alert('Tính năng gửi email đang được phát triển');
}
</script>

{{else}}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i> Không tìm thấy thông tin đặt xe
</div>
{{/if}}
